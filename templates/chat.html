
{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <div class="chat-box" id="chat-box">
        <!-- As mensagens do chat serÃ£o inseridas aqui pelo JavaScript -->
    </div>
    <div class="chat-input-area">
        <textarea id="user-input" placeholder="Converse com o CalendAI... (Shift+Enter para nova linha)" rows="1"></textarea>
        <button id="send-btn">Enviar</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const token = '{{ token }}';
        let messages = [];

        function appendMessage(sender, text, isTyping = false) {
            const existingTyping = document.querySelector('.assistant-typing');
            if (existingTyping) {
                existingTyping.remove();
            }

            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message', `${sender}-message`);

            if (isTyping) {
                messageWrapper.classList.add('assistant-typing');
                messageWrapper.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            } else {
                // Sanitize and render markdown
                messageWrapper.innerHTML = marked.parse(text || '');
            }
            
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText) return;

            appendMessage('user', userText);
            messages.push({ role: 'user', content: userText });
            
            userInput.value = '';
            userInput.style.height = 'auto'; // Reset height
            
            appendMessage('assistant', '', true); // Show typing indicator

            try {
                const response = await fetch('/chat?token=' + token, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = errorData.reply || `Erro ${response.status}: ${response.statusText}`;
                    appendMessage('assistant', `âš ï¸ **Desculpe, ocorreu um erro no servidor:** ${errorMessage}`);
                    return;
                }

                const data = await response.json();
                messages = data.messages || [];
                appendMessage('assistant', data.reply);

            } catch (error) {
                console.error('Fetch error:', error);
                appendMessage('assistant', 'âš ï¸ **Erro de conexÃ£o.** NÃ£o foi possÃ­vel contatar o servidor.');
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = `${userInput.scrollHeight}px`;
        });

        // Initial welcome message
        messages.push({ role: 'assistant', content: 'OlÃ¡! ðŸ‘‹ Eu sou o CalendAI. Como posso ajudar a organizar sua agenda hoje?' });
        appendMessage('assistant', messages[0].content);
    });
</script>
{% endblock %}
