
{% extends "base.html" %}

{% block content %}
<div class="chat-history" id="chat-history">
    <!-- As mensagens do chat ser√£o inseridas aqui dinamicamente -->
</div>

<div class="chat-input-area">
    <textarea id="message-input" placeholder="Converse com o CalendAI..." required rows="1"></textarea>
    <button id="send-button" type="submit">
        <svg class="send-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const sendButton = document.getElementById('send-button');
        const messageInput = document.getElementById('message-input');
        const chatHistory = document.getElementById('chat-history');

        // --- Hist√≥rico da Conversa e Prompt do Sistema com Exclus√£o ---
        let messages = [
            {
                role: 'system',
                content: `
                    Voc√™ √© o CalendAI, um assistente de calend√°rio inteligente e direto ao ponto.

                    **Sua Personalidade:**
                    - Cordial, eficiente e sempre prestativo.

                    **Regras de Comportamento (CR√çTICAS):**
                    1.  **V√° Direto ao Ponto:** Use as ferramentas para responder aos pedidos do usu√°rio sem anunciar suas a√ß√µes. Sua resposta j√° deve ser o resultado final.
                    2.  **Como Listar Eventos:**
                        - Para "o que tenho hoje?", use list_events com relative_date: 'hoje'.
                        - Para "e amanh√£?", use list_events com relative_date: 'amanha'.
                        - Para "pr√≥ximos 5 dias", use list_events com duration_days: 5.
                    3.  **Como Criar Eventos:**
                        - Use a ferramenta create_event quando o usu√°rio pedir para marcar, agendar ou criar algo.
                    4.  **Como Excluir Eventos (FLUXO DE DUAS ETAPAS):**
                        - **ETAPA 1: BUSCAR O EVENTO.** Se o usu√°rio pedir para excluir um evento (ex: "exclua minha reuni√£o de marketing"), voc√™ DEVE primeiro usar a ferramenta list_events com o par√¢metro query preenchido com o nome do evento (ex: "reuni√£o de marketing"). Isso retornar√° o ID do evento.
                        - **ETAPA 2: EXCLUIR O EVENTO.** Depois de obter o ID, use a ferramenta delete_event com o event_id correto para exclu√≠-lo.
                        - Se list_events retornar v√°rios eventos, pergunte ao usu√°rio qual deles ele deseja excluir.
                    5.  **Cumprimentos:** Se o usu√°rio apenas disser "oi" ou "bom dia", responda de forma amig√°vel e se coloque √† disposi√ß√£o, SEM usar nenhuma ferramenta.

                    **Regras de Formata√ß√£o:**
                    - Ao listar eventos, use Markdown e coloque o t√≠tulo dos eventos em negrito.
                `
            },
            // --- Exemplo (Few-Shot) para Cumprimento ---
            {
                role: "user",
                content: "Oi"
            },
            {
                role: "assistant",
                content: "Oi! üòä Sou o CalendAI. Como posso ajudar com sua agenda hoje?"
            }
        ];
        
        appendMessage('assistant', 'Ol√°! üëã Eu sou o CalendAI. O que voc√™ gostaria de organizar na sua agenda?');

        // --- Event Listeners & Fun√ß√µes do Chat (sem altera√ß√µes) ---
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        messageInput.addEventListener('input', adjustInputHeight);

        function appendMessage(role, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('chat-message', role + '-message');
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
            let htmlContent = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            bubble.innerHTML = htmlContent;
            if (role === 'assistant') {
                const avatar = document.createElement('div');
                avatar.classList.add('assistant-avatar');
                avatar.innerHTML = `<img src="{{ url_for('static', filename='6014401-1776079058.png') }}" alt="Assistente">`;
                messageWrapper.appendChild(avatar);
            }
            messageWrapper.appendChild(bubble);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function sendMessage() {
            const userMessageText = messageInput.value.trim();
            if (!userMessageText) return;
            appendMessage('user', userMessageText);
            messages.push({ role: 'user', content: userMessageText });
            messageInput.value = '';
            adjustInputHeight();
            const thinkingIndicator = appendThinkingIndicator();
            try {
                const response = await fetch("{{ url_for('chat', token=token) }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages })
                });
                thinkingIndicator.remove();
                if (response.ok) {
                    const data = await response.json();
                    messages = data.messages;
                    appendMessage('assistant', data.reply);
                } else {
                    const errorData = await response.json();
                    appendMessage('assistant', `Erro: ${errorData.reply || 'N√£o foi poss√≠vel obter uma resposta.'}`);
                }
            } catch (error) {
                thinkingIndicator.remove();
                appendMessage('assistant', 'Desculpe, n√£o foi poss√≠vel conectar ao servidor.');
            }
        }

        function appendThinkingIndicator() {
            const thinkingElement = document.createElement('div');
            thinkingElement.classList.add('chat-message', 'assistant-message', 'thinking');
            thinkingElement.innerHTML = `
                <div class="assistant-avatar">
                    <img src="{{ url_for('static', filename='6014401-1776079058.png') }}" alt="Assistente">
                </div>
                <div class="message-bubble">...</div>
            `;
            chatHistory.appendChild(thinkingElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return thinkingElement;
        }

        function adjustInputHeight() {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        }
    });
</script>
{% endblock %}
